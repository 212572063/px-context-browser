<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-context-browser-behaviors.html"/>
<link rel="import" href="px-column.html"/>

<dom-module id="px-column-browser">
  <link rel="import" type="css" href="css/px-context-browser.css" />
  <script src="../lodash/lodash.js"></script>
  <template>
    <div id="widthTest" class="flex flex--col column-browser">
      <px-spinner id="spinner" finished></px-spinner>
      <div id="columns" class$="[[_columnsClassNames]]">
        <template is="dom-repeat" id="levels" items="[[_columns]]">
          <px-column
            column-data="[[item]]"
            field-keys="[[fieldKeys]]"
            context="[[context]]">
          </px-column>
        </template>
      </div>
      <div id="rulers" class="ruler"></div>
      <div class="overlay"></div>
    </div>
  </template>
  <script>
    Polymer({

      is: 'px-column-browser',

      behaviors: [PxContextBrowserBehaviors],

      properties: {

        _columns: {
          type: Array,
          value: function() { return []; }
        },

        _columnsClassNames: {
          type: String,
          computed: '_computeColumnsClassNames(context)'
        }

      },

      observers: [
        '_contextChanged(fieldKeys, _columns, context, context.localUpdatedAt)'
      ],

      _computeColumnsClassNames: function() {
        console.log('_computeColumnsClassNames');
        // return 'flex';
        return 'flex ' + this._columnIndexClassName(); // + ' ' + this._numColumnsClassName();
      },

      _getTotalColumnCount: function() {
        var columnBrowserColumns = this.$.columns.querySelector('div:first-of-type');
        var removedCount = this.$.columns.querySelectorAll('.removed').length;
        this._columns.length - removedCount;
      },

      _getFitColumnCount: function() {
        var width = this.$.columns.offsetWidth;
        console.log('width: ', width);
        console.log('ruler width: ', this.$.widthTest.offsetWidth);
        return Math.floor(width / this.$.widthTest.offsetWidth);
      },

      _numColumnsClassName: function() {
        var columns = this._getFitColumnCount();
        return 'columns-' + columns;
      },

      _columnIndexClassName: function() {
        var count = this._getTotalColumnCount();
        var columns = this._getFitColumnCount();
        if (count > columns) {
          return 'column-index-' + (count - columns);
        } else {
          return '';
        }
      },

      _contextChanged: function() {
        if(!_.isEmpty(this.context)) {
          this._setColumns();
        }
      },

      // remove all columns so that they can be reset
      _popAllColumns: function() {
        _.forEach(this._columns, this._popColumn.bind(this));
      },

      // pop one single columnItem off this._columnItems
      _popColumn: function() {
        this.pop('_columns');
      },

      _isSelected(node) {
        return (typeof node.selected !== 'undefined' && node.selected === true);
      },

      _addColumn(node, index) {
        var childrenKey = this.fieldKeys['children'];
        var children = node[childrenKey] || [];
        var i, len = children.length;
        if(len > 0) {
          if(!_.isEqual(this._columns[index], { children })) {
            this.push('_columns', { children });
          }
          for(i=0;i<len;i++) {
            var childNode = children[i];
            if(this._isSelected(childNode)) {
              var grandChildren = childNode[childrenKey];
              if(typeof grandChildren !== 'undefined' && grandChildren.length > 0) {
                index++;
                this._addColumn(childNode, index);
              }
            }
          }
        }
      },

      _removeColumn: function(index) {
        if(this._columns) {
          this.splice('_columns', index, 1);
        }
      },

      _setColumns: function() {
        this._addColumn(this.context, 0);
        /*
        if(_.isEmpty(this._columns)) {
          // add the first column
          this.push('_columns', { children });
        } else {
          console.log('update existing columns')
          // update existing columns
          this.set('_columns.0', { children });
          _.each(children, function(child) {
            if(child.selected) {
              console.log('child selected:', child);
            }
          });
          // TODO: Recursively add more columns as children have many children...
          }
        */
      },

      showOverlay: function() {
        this.$$('.overlay').style.display = 'block';
      },

      hideOverlay: function() {
        this.$$('.overlay').style.display = 'none';
      },

      showSpinner: function() {
        this.$.spinner.set('finished', false);
      },

      hideSpinner: function() {
        this.$.spinner.set('finished', true);
      }

    });
  </script>
</dom-module>
