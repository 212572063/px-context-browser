<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-context-browser-column.html"/>
<link rel="import" href="px-context-browser-behaviors.html"/>

<dom-module id="px-context-browser-column-browser">
  <link rel="import" type="css" href="css/px-context-browser.css" />
  <script src="../lodash/lodash.js"></script>
  <template>
    <div class="flex flex--col column-browser">
      <px-spinner id="spinner" finished></px-spinner>
      <div class="flex">
        <template is="dom-repeat" id="levels" items="[[_columns]]">
          <px-context-browser-column
            column-data="[[item]]"
            field-keys="[[fieldKeys]]"
            context="[[context]]"></px-context-browser-column>
        </template>
      </div>
      <div class="ruler">
      </div>
      <div class="overlay"></div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'px-context-browser-column-browser',
    behaviors: [PxContextBrowserBehaviors],
    properties: {
      _columns: {
        type: Array,
        value: function() { return []; }
      }
    },

    observers: [
      '_contextChanged(fieldKeys, _columns, context, context.localUpdatedAt)'
    ],

    _contextChanged: function() {
      if(!_.isEmpty(this.context)) {
        var children = this.context[this.fieldKeys['children']] || [];
        console.log('_contextChanged children', children);
        this._setColumns(children);
      } else {
        this.columns = [];
        // merge with existing?
      }
    },

    _setColumns: function(children) {
      if(_.isEmpty(this._columns)) {
        // add the first column
        this.push('_columns', { children });
      } else {
        // update existing columns
        this.set('_columns.0', { children });
        // TODO: Recursively add more columns as children have many children...
      }
    },



    showOverlay: function() {
      this.$$('.overlay').style.display = 'block';
    },

    hideOverlay: function() {
      this.$$('.overlay').style.display = 'none';
    },

    showSpinner: function() {
      this.$.spinner.set('finished', false);
    },

    hideSpinner: function() {
      this.$.spinner.set('finished', true);
    }

  });
</script>
