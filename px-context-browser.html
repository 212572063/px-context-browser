<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs
-->
<!--suppress HtmlUnknownTarget -->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-spinner/px-spinner.html"/>
<link rel="import" href="../px-overlay/px-overlay.html"/>
<link rel="import" href="px-context-browser-behaviors.html"/>
<link rel="import" href="px-breadcrumbs.html"/>
<link rel="import" href="px-column-browser.html"/>
<link rel="import" href="px-context-browser-header.html"/>
<link rel="import" href="px-context-browser-model.html"/>

<style>
  [dir=rtl] .fa.px-context-browser {
    -webkit-transform: scale(-1, 1);
    transform: scale(-1, 1);
  }
  [dir=rtl] .fa.px-context-browser {
    -webkit-transform: scale(-1, 1);
    transform: scale(-1, 1);
  }
  :host {
    display: block;
    margin-bottom: 5px;
  }
</style>

<dom-module id="px-context-browser">
  <link rel="import" type="css" href="css/px-context-browser.css" polyfill-next-selector/>
  <script src="../lodash/lodash.js"></script>
  <template>
    <px-context-browser-model
      id="model"
      api-url="[[apiUrl]]"
      selected-item-uri="[[_selectedItemUri]]"
      context="{{_context}}"></px-context-browser-model>
    <px-overlay
      id="overlay"
      type="dark"
      class$="[[_overlayClassNames]]"></px-overlay>
    <div id="back">
      <div class="column-browser-container flex flex--col">
        <px-context-browser-header
          id="header"
          opened-breadcrumbs="[[openedBreadcrumbs]]"
          opened-item-name="[[openedItemName]]">
          <content></content>
        </px-context-browser-header>
        <div id="ruler" class="flex flex--col">
          <div class="flex flex--col">
            <px-breadcrumbs
              class$="[[_breadcrumbsClassNames]]">
            </px-breadcrumbs>
            <px-column-browser
              id="columnBrowser"
              parent-nodes="[[parentNodes]]"
              field-keys="[[fieldKeys]]"
              context="[[_context]]"
              show-column-browser="[[_showColumnBrowser]]"
              class$="[[_columnBrowserClassNames]]">
            </px-column-browser>
          </div>
        </div>
      </div>
    </div>
  </template>
  <script>
    Polymer({

      is: 'px-context-browser',

      behaviors: [PxContextBrowserBehaviors],

      properties: {

        apiUrl: {
          type: String
        },

        rootUri: {
          type: String
        },

        _selectedItemUri: {
          type: String
        },

        /**
        * Mapping for the field name in the context data that represents the display label for an item.
        * This property allows data of any form/keys to be used as long as it has the notion of a 'display label' in it.
        *
        * @type {String}
        * @default "name"
        */
        labelField: {
          type: String,
          value: "name"
        },
        /**
         * Mapping for the field name in the context data that represents a unique id for an item. This property allows data of any form/keys to be used as
         * long as it has the notion of a 'unique id' in it.
         * @type {String}
         * @default "id"
         */
        idField: {
          type: String,
          value: "id"
        },
        /**
         * Mapping for the field name in the context data that represents an array of children
         * for an item. This property allows data of any form/keys to be used as long as it has
         * the notion of a 'unique id' in it.
         * @type {String}
         * @default "id"
         */
        childrenField: {
          type: String,
          value: "children"
        },

        /**
         * Initial context name to be shown on page
         *
         * @type {String}
         * @default 'Select Context'
         */
        openedItemName: {
          type: String,
          value: 'Select Context'
        },
        /**
         * flag to show column browser
         * @type {Boolean}
         * @default false
         */
        _showColumnBrowser: {
          type: Boolean,
          value: false
        },
        /**
         * opened item breadcrumb
         * @type {Array}
         * @default []
         * @private
         */
        openedBreadcrumbs: {
          type: Array,
          value: function() {return [];}
        },
        /**
         * show chevron
         * @type {Boolean}
         * @default false
         *
         */
        showChevron: {
          type: Boolean,
          value: true,
          reflectToAttribute: true
        },
        _overlayClassNames: {
          type: String,
          computed: '_computeOverlayClassNames(_showColumnBrowser)'
        },
        _columnBrowserClassNames: {
          type: String,
          computed: '_computeColumnBrowserClassNames(_showColumnBrowser)'
        },
        _breadcrumbsClassNames: {
          type: String,
          computed: '_computeBreadcrumbsClassNames(_showColumnBrowser)'
        }
      },

      observers: [
        "_setFieldKeys(childrenField, idField, labelField)",
        "_contextChanged(context)"
      ],

      listeners: {
        'item-click': '_itemClickHandler',
        'header-click': '_headerClickHandler'
      },

      ready: function() {
        this._selectedItemUri = this.rootUri;
      },

      _contextChanged: function(context) {
        console.log('context', context);
      },

      /**
       * set fieldKeys values to be used by many sub-components
      */
      _setFieldKeys: function() {
        this.set('fieldKeys', {
          id: this.idField,
          children: this.childrenField,
          label: this.labelField
        });
      },

      /**
       * handles 'item-click' event fired from column-item
      */
      _itemClickHandler: function(e) {
        var item = e.detail.item;
        this._selectedItemUri = item.uri;
      },

      /**
       * handles 'header-click' event fired from column-item
      */
      _headerClickHandler: function(e) {
        this.toggleColumnBrowser();
      },

      /**
       * toggle visbility of the column browser
      */
      toggleColumnBrowser: function() {
        this.set('_showColumnBrowser', !this._showColumnBrowser);
      },

      /**
       * compute _breadcrumbsClassNames
      */
      _computeBreadcrumbsClassNames: function() {
        var base = 'flex flex--col';
        return this.removeConditionalClass(this._showColumnBrowser, 'visuallyhidden', base);
      },

      /**
       * compute _columnBrowserClassNames
      */
      _computeColumnBrowserClassNames: function() {
        var base = 'flex flex--col column-browser';
        return this.removeConditionalClass(this._showColumnBrowser, 'visuallyhidden', base);
      },

      /**
       * compute _overlayClassNames
      */
      _computeOverlayClassNames: function() {
        return this.addConditionalClass(this._showColumnBrowser, 'fadeFromHidden');
      }

    });
  </script>

</dom-module>
