<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-context-browser-behaviors.html"/>

<dom-module id="px-context-browser-column-item">
  <link rel="import" type="css" href="css/px-context-browser.css" />
  <template>
    <li on-click="itemClickHandler" id$="[[itemId]]" class$="{{_itemClassNames}}">
      <span class="flex__item item-label">{{itemLabel}}</span>
      {{_isSelected}}
      <button class$="[[_openButtonClass]]" on-click="openClickHandler" key$="[[itemId]]">
        Open
      </button>
      <template is="dom-if" if="{{_hasChildren}}">
        <span class="chevron"><i class="fa fa-angle-right"></i></span>
      </template>
    </li>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'px-context-browser-column-item',
    behaviors: [PxContextBrowserBehaviors],
    properties: {
      /**
       * Item data passed from parent menu
       *
       * @type {Object}
       * @default null
       */
      columnItem: {
        type: Object,
        value: null
      },
      /**
       * show chevron
       * @type {Boolean}
       * @default false
       *
       */
      showChevron: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },

      testValue: 'test',

      fieldKeys: {
        type: Object
      },

      _openButtonClass: {
        type: String,
        value: 'temp-item-opener-class',
        computed: '_computeOpenButtonClass(columnItem, _baseOpenButtonClassNames)'
      },

      itemId: {
        type: String,
        computed: '_computeItemId(columnItem, fieldKeys)'
      },

      itemLabel: {
        type: String,
        computed: '_computeItemLabel(columnItem, fieldKeys)'
      },

      _itemClassNames: {
        type: Boolean,
        value: false,
        computed: '_computeItemClassNames(columnItem)'
      },

      _hasChildren: {
        type: Boolean,
        value: false,
        computed: '_computeHasChildren(columnItem)'
      },

      _baseOpenButtonClassNames: {
        type: String,
        value: 'opener btn btn--small btn--tertiary '
      },

      _baseItemClassNames: {
        type: String,
        value: 'flex flex--middle selectable-item'
      },

      _isSelected: {
        type: Boolean,
        computed: '_computeIsSelected(columnItem)'
      }

    },

    observers: [
      '_columnItemSelectedChanged(columnItem.selected)'
    ],

    ready: function() {

      // console.log(this.showChevron);
    },

    _columnItemSelectedChanged: function(item) {
      // console.log('asdf');
    },

    _computeOpenButtonClass: function(item) {
      var openableClassName = item.isOpenable ? "openable" : "unopenable";
      return this._baseOpenButtonClassNames + openableClassName;
    },

    _computeIsSelected: function(item) {
      // console.log('_computeIsSelected', item.selected === false);
      return item.selected === true;
    },

    menu: null,

    _computeItemId: function(item) {
      return item ? item[this.fieldKeys.id] : null;
    },

    _computeItemLabel: function(item) {
      return item ? item[this.fieldKeys.label] : null;
    },

    /* returns string to be used for _itemClassNames */
    _computeItemClassNames: function(item) {
      // console.log(item._isSelected);
      return this.addConditionalClass(item._isSelected, "selected", this._baseItemClassNames);
    },

    _computeHasChildren: function(item) {
      //console.log(item);
      //console.log(item.hasChildren, item.children);
      return (this.showChevron) ? (item.hasChildren || item.children) : false;
    },

    /**
     * Event listener on item clicks, listener is registered from the template
     *
     * @param {Event} evt
     * @private
     */
    itemClickHandler: function(evt) {
      this.debounce('itemClick', function() {
        this.fire('item-click', { 'itemId': this.columnItem['id'] } );
      }, 1);
    },

    _openClickHandler: function() {

    },

    /**
     * this method checks whether the attribute hasChildren has been set to true, and if it has,
     * whether the item has a property by the name of children or hasChildren
     * @param {object} item
     * @private
     */
    _hasChildren: function() {
      return (this.showChevron) ? (this.item.hasChildren || this.item.children) : false;
    },

    /**
     * @param {Object} item
     * @return {String} Display label for given item
     * @private
     */
    getItemLabel: function(item) {
      return item ? item[this.parent.labelField] || '' : '';
    },

    /**
     * @param {Object} item
     * @return {String} Id for given item
     * @private
     */
    getItemId: function(item) {

    },

    /**
     * @param {Object} item
     * @return {String} CSS class for item opener
     * @private
     */
    getItemOpenerClass: function() {

    },

    /**
     * @param {String} base
     * @return {String} CSS class for item
     * @private
     */
    isItemSelected: function(selectedItem) {

    },

    /**
     * Observer on LI, and whether they should show up. replaces polymer hidden, which seems to be shaky with IE.
     * if base_classes is passed in, it is returned with the appropriate response.
     *
     * @param {string} item
     * param {string} base_classes
     * @private
     */
    isItemHidden: function(item, base_classes) {
      if (base_classes  !== undefined) {
        return base_classes += (!item) ? " visuallyhidden" : '';
      } else {
        return (!item) ? "visuallyhidden" : '';
      }
    }
  });
</script>
